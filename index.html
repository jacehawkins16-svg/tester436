<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification Log Dashboard</title>
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/768px-Google_%22G%22_logo.svg.png"> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Deep, dark, responsive background */
            background: linear-gradient(135deg, #0f172a 0%, #020412 100%);
            min-height: 100vh; 
            color: #e2e8f0;
        }
        .container-card {
            background: #1e293b; 
            border: 1px solid #334155;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }
        /* Style for the table header */
        .data-table th {
            background-color: #334155;
            color: #cbd5e1;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
        }
        /* Style for table data cells */
        .data-table td {
            padding: 12px 16px;
            border-top: 1px solid #334155;
            color: #d1d5db;
            font-size: 0.875rem; /* sm */
        }
        /* Hover effect for table rows */
        .data-table tbody tr:hover {
            background-color: #273449;
        }
        
        /* Custom scrollbar for aesthetic consistency */
        ::-webkit-scrollbar { width: 8px; background-color: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: #1e293b; }
        ::-webkit-scrollbar-thumb:hover { background-color: #64748b; }

    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-7xl mx-auto container-card rounded-2xl p-6 sm:p-10 mt-8">
        <h1 class="text-4xl font-extrabold mb-2 text-white">Network Report Dashboard</h1>
        <p class="text-indigo-400 mb-8">Real-time log of network client reports.</p>

        <!-- Loading State -->
        <div id="loading-state" class="bg-indigo-900/30 border border-indigo-700/50 p-6 rounded-lg text-center text-indigo-300 font-semibold">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-300 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Connecting to Database and Fetching Reports...
        </div>

        <!-- Error State: Hidden unless Firebase setup or listener fails -->
        <div id="error-state" class="bg-red-900/30 border border-red-700/50 p-6 rounded-lg text-center hidden mb-8">
            <h2 class="text-xl font-bold text-red-300 mb-2">Database Error:</h2>
            <p id="error-message" class="text-red-400">Loading failed due to an unknown error.</p>
        </div>

        <!-- Table Container -->
        <div class="overflow-x-auto shadow-xl rounded-lg">
            <table class="min-w-full divide-y divide-gray-700 data-table">
                <thead>
                    <tr>
                        <th scope="col" class="min-w-[120px] sticky left-0 z-10">Client Name</th>
                        <th scope="col">IP Address</th>
                        <th scope="col">Location (City/Region/Country)</th>
                        <th scope="col">Browser/OS</th>
                        <th scope="col">ISP/Org</th>
                        <th scope="col">Battery</th>
                        <th scope="col">Time Logged</th>
                    </tr>
                </thead>
                <tbody id="reports-body" class="divide-y divide-gray-800">
                    <!-- Placeholder row, replaced by JavaScript upon data load -->
                    <tr><td colspan="7" class="text-center py-4 text-gray-500">No reports found.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Safely parse the Firebase configuration string
        const firebaseConfig = (() => {
            try {
                return JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            } catch (e) {
                console.error("Failed to parse __firebase_config:", e);
                return {};
            }
        })();
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- DOM Elements ---
        const reportsBody = document.getElementById('reports-body');
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const errorMessageEl = document.getElementById('error-message');

        // --- Firebase Instances & State ---
        let db; // Firestore instance
        let authReady = false; // Flag to ensure listener only starts after auth is successful
        let firebaseInitPromise = null; // Promise to ensure initialization only runs once

        // --- Constants ---
        // Path for public data shared between the two applications
        const PUBLIC_COLLECTION_PATH = `artifacts/${appId}/public/data/network_reports`;
        
        /**
         * Initializes Firebase, signs in the user, and sets the authReady flag.
         * This function is crucial for preventing database access before the environment is ready.
         */
        function setupFirebase() {
            if (firebaseInitPromise) return firebaseInitPromise; 

            firebaseInitPromise = new Promise(async (resolve) => {
                // 1. Validation Check: Ensure configuration is present
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    const message = "Database Error: Firebase configuration is not set up correctly.";
                    console.error(message);
                    loadingState.classList.add('hidden');
                    errorMessageEl.textContent = message;
                    errorState.classList.remove('hidden');
                    // authReady remains false, preventing listenForReports from running
                    return resolve(); 
                }
                
                try {
                    // 2. Initialize App and Services
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    const auth = getAuth(app);
                    
                    // 3. Authenticate (using custom token if available, otherwise anonymously)
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    // 4. Success: Set the ready flag
                    authReady = true;
                    console.log("Firebase Authentication complete. Listener ready.");
                    resolve();
                    
                } catch (error) {
                    // 5. Failure: Display error
                    const message = `Database Error: Initialization/Authentication failed. ${error.message}`;
                    console.error(message, error);
                    loadingState.classList.add('hidden');
                    errorMessageEl.textContent = message;
                    errorState.classList.remove('hidden');
                    resolve(); 
                }
            });

            return firebaseInitPromise;
        }

        /**
         * Renders the fetched reports into the table body.
         * @param {Array<Object>} reports Array of report objects.
         */
        function renderReports(reports) {
            reportsBody.innerHTML = '';
            
            if (reports.length === 0) {
                reportsBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No reports found yet.</td></tr>';
                return;
            }

            // Sort by timestamp (most recent first)
            reports.sort((a, b) => new Date(b.logTimestamp) - new Date(a.logTimestamp));

            for (const report of reports) {
                const row = document.createElement('tr');
                
                // Concatenate location data
                const locationText = `${report.city || 'N/A'}, ${report.region || 'N/A'}, ${report.country || 'N/A'}`;
                // Concatenate browser and OS
                const browserOSText = `${report.browser || 'N/A'} / ${report.os || 'N/A'}`;
                
                let batteryText = 'N/A';
                if (report.batteryLevel !== null && report.batteryLevel !== undefined) {
                    const levelPercent = (report.batteryLevel * 100).toFixed(0);
                    const chargingStatus = report.isCharging ? 'Charging' : 'Discharging';
                    batteryText = `${levelPercent}% (${chargingStatus})`;
                }
                
                // Create table row with data
                row.innerHTML = `
                    <td class="sticky left-0 bg-[#1e293b] font-medium text-white rounded-l-lg">${report.name || 'Anonymous'}</td>
                    <td class="font-mono text-xs">${report.ip || 'N/A'}</td>
                    <td class="text-xs">${locationText}</td>
                    <td class="text-xs">${browserOSText}</td>
                    <td class="text-xs min-w-[150px]">${report.org || 'N/A'}</td>
                    <td class="text-xs">${batteryText}</td>
                    <td class="rounded-r-lg">${report.localTimeFormatted || 'N/A'}</td>
                `;
                reportsBody.appendChild(row);
            }
        }

        /**
         * Sets up the real-time listener for the Firestore collection.
         */
        function listenForReports() {
            // CRITICAL GUARD: Only proceed if Firebase is initialized and authenticated
            if (!db || !authReady) {
                 console.error("Attempted to listen for reports before authentication was complete/successful.");
                 return;
            }

            const q = query(collection(db, PUBLIC_COLLECTION_PATH));
            
            // onSnapshot sets up a real-time listener that updates the UI whenever data changes
            const unsubscribe = onSnapshot(q, (snapshot) => {
                loadingState.classList.add('hidden'); // Hide loading state once initial data is received
                errorState.classList.add('hidden'); // Ensure error state is hidden on success
                const reports = [];
                snapshot.forEach((doc) => {
                    reports.push({ id: doc.id, ...doc.data() });
                });
                renderReports(reports);
            }, (error) => {
                // Handle real-time listener errors
                console.error("Error listening to collection:", error);
                loadingState.classList.add('hidden');
                errorMessageEl.textContent = `Real-time feed failed: ${error.message}`;
                errorState.classList.remove('hidden');
            });
            
            // Note: The listener will remain active until the window is closed or this unsubscribe function is called.
            console.log("Real-time listener started.");
        }

        // --- Application Setup ---
        window.onload = async function() {
            // Step 1: Initialize and Authenticate Firebase
            await setupFirebase(); 
            
            // Step 2: Only start listening if the authentication succeeded
            if (authReady) {
                listenForReports();
            } else {
                // If auth failed, setupFirebase already updated the UI error message.
                console.log("Not starting listener because Firebase setup failed.");
            }
        };
    </script>
</body>
</html>
