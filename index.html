<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification Log Dashboard</title>
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/768px-Google_%22G%22_logo.svg.png"> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #020412 100%);
            min-height: 100vh; 
            color: #e2e8f0;
        }
        .container-card {
            background: #1e293b; 
            border: 1px solid #334155;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }
        .data-table th {
            background-color: #334155;
            color: #cbd5e1;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 2px solid #475569;
        }
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #334155;
        }
        .data-table tr:hover {
            background-color: #2d3748;
        }
        /* Custom Scrollbar for the table container */
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        .log-container::-webkit-scrollbar-thumb {
            background-color: #475569;
            border-radius: 4px;
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-7xl mx-auto container-card rounded-2xl p-6 md:p-10">
        <h1 class="text-4xl font-extrabold mb-2 tracking-tight text-indigo-400">
            Access Verification Log
        </h1>
        <p class="text-gray-400 mb-6">Real-time feed of network and device reports sent from the client application.</p>
        
        <!-- Loading and Error States -->
        <div id="loading-state" class="text-center p-8 text-indigo-300">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Establishing secure connection and fetching logs...
        </div>

        <div id="error-state" class="hidden bg-red-800 p-4 rounded-lg text-red-200">
            <p class="font-bold">Database Error:</p>
            <p id="error-message"></p>
        </div>

        <!-- Log Table Container -->
        <div id="log-container" class="log-container overflow-x-auto max-h-[70vh] rounded-xl">
            <table class="data-table w-full text-sm">
                <thead>
                    <tr>
                        <!-- Added more detailed headers -->
                        <th class="sticky top-0 z-10">User Name</th>
                        <th class="sticky top-0 z-10">Public IP</th>
                        <th class="sticky top-0 z-10">Location (City, Region)</th>
                        <th class="sticky top-0 z-10">ISP/Org (ASN)</th>
                        <th class="sticky top-0 z-10">Browser/OS</th>
                        <th class="sticky top-0 z-10">Resolution</th>
                        <th class="sticky top-0 z-10">Connection</th>
                        <th class="sticky top-0 z-10">Battery/Charge</th>
                        <th class="sticky top-0 z-10">Log Time (Local)</th>
                    </tr>
                </thead>
                <tbody id="reports-body">
                    <!-- Reports will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div id="no-reports-state" class="hidden text-center p-8 text-gray-500">
            No verification reports have been logged yet.
        </div>
    </div>


    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Global Variables (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- DOM Elements ---
        const reportsBody = document.getElementById('reports-body');
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const errorMessageEl = document.getElementById('error-message');
        const noReportsState = document.getElementById('no-reports-state');

        // --- Firebase Instances & State ---
        let db, auth;
        let authReady = false;
        
        // --- Constants ---
        // Path MUST match the path used by the client site
        const PUBLIC_COLLECTION_PATH = `artifacts/${appId}/public/data/network_reports`; 
        
        /**
         * Initializes Firebase and authenticates the user anonymously.
         */
        async function setupFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.error("Firebase configuration is missing.");
                errorMessageEl.textContent = "Firebase configuration is not set up correctly.";
                errorState.classList.remove('hidden');
                loadingState.classList.add('hidden');
                return; 
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in (use custom token if available, otherwise anonymously)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                authReady = true;
                console.log("Firebase Authentication complete. Ready to fetch logs.");
                
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                errorMessageEl.textContent = `Authentication failed: ${error.message}. Check browser console for details.`;
                errorState.classList.remove('hidden');
                loadingState.classList.add('hidden');
            }
        }
        
        /**
         * Renders the fetched reports into the table.
         * @param {Array<Object>} reports The list of reports from Firestore.
         */
        function renderReports(reports) {
            reportsBody.innerHTML = ''; // Clear existing rows
            
            if (reports.length === 0) {
                noReportsState.classList.remove('hidden');
            } else {
                noReportsState.classList.add('hidden');
                // Sort by timestamp (newest first)
                reports.sort((a, b) => new Date(b.logTimestamp) - new Date(a.logTimestamp));
                
                reports.forEach(report => {
                    const row = document.createElement('tr');
                    
                    // Use report.name as the User Name
                    // Style row based on connection type for visual distinction
                    const connection = report.connectionSpeed || 'N/A';
                    const statusClass = connection.includes('4g') || connection.includes('wifi') ? 'text-green-300' : 
                                        connection.includes('3g') || connection.includes('2g') ? 'text-yellow-300' : 'text-gray-300';

                    // Format battery information
                    let batteryText = 'N/A';
                    if (report.batteryLevel !== undefined && report.batteryLevel !== null) {
                        const level = (report.batteryLevel * 100).toFixed(0);
                        const chargingStatus = report.isCharging === true ? 'Charging' : (report.isCharging === false ? 'Discharging' : '');
                        batteryText = `${level}% ${chargingStatus}`;
                    }


                    row.innerHTML = `
                        <td class="font-bold whitespace-nowrap ${statusClass}">${report.name || 'Unknown'}</td>
                        <td class="font-mono text-xs">${report.ip || 'N/A'}</td>
                        <td>${report.city || 'N/A'}, ${report.region || ''} ${report.country || 'N/A'}</td>
                        <td class="text-xs">
                            ${report.org || 'N/A'} 
                            <span class="text-gray-500">(${report.asn || 'N/A'})</span>
                        </td>
                        <td class="text-xs">
                            ${report.browser || 'N/A'} / ${report.os || 'N/A'}
                            <div class="text-gray-500 text-[10px] truncate">${report.userAgent || ''}</div>
                        </td>
                        <td class="text-xs">${report.screenResolution || 'N/A'}</td>
                        <td class="text-xs">${connection}</td>
                        <td class="text-xs">${batteryText}</td>
                        <td>${report.localTimeFormatted || 'N/A'}</td>
                    `;
                    reportsBody.appendChild(row);
                });
            }
        }

        /**
         * Sets up the real-time listener for the Firestore collection.
         */
        function listenForReports() {
            if (!db || !authReady) return;

            const q = query(collection(db, PUBLIC_COLLECTION_PATH));
            
            // onSnapshot sets up a real-time listener
            onSnapshot(q, (snapshot) => {
                loadingState.classList.add('hidden'); // Hide loading state once initial data is received
                const reports = [];
                snapshot.forEach((doc) => {
                    reports.push({ id: doc.id, ...doc.data() });
                });
                renderReports(reports);
            }, (error) => {
                console.error("Error listening to collection:", error);
                errorMessageEl.textContent = `Real-time feed failed: ${error.message}`;
                errorState.classList.remove('hidden');
                loadingState.classList.add('hidden');
            });
        }

        // --- Application Setup ---
        window.onload = async function() {
            await setupFirebase(); 
            
            if (authReady) {
                listenForReports();
            }
        };
    </script>
</body>
</html>
