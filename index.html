<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Data Store Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate Dark Blue */
            color: #e2e8f0; /* Off-White */
            min-height: 100vh;
        }
        .header-gradient {
            background: linear-gradient(90deg, #6366f1, #a78bfa, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        .data-card {
            background-color: #1e293b; /* Darker Slate */
            border: 1px solid #334155;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
        }
        /* New: Full-screen overlay for the access gate */
        #whitelist-gate {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.95); /* Semi-transparent dark overlay */
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="text-center mb-10">
        <h1 class="text-4xl md:text-5xl font-extrabold header-gradient tracking-tight">
            NETWORK DATA LOGGING DASHBOARD
        </h1>
        <p class="text-gray-400 mt-2">Real-time reports transferred from client sites.</p>
        <div id="auth-info" class="text-xs mt-4 p-2 bg-gray-800 rounded-lg max-w-lg mx-auto">
            <p id="app-id-display">App ID: Loading...</p>
            <p id="user-id-display" class="mt-1">User ID: Loading...</p>
        </div>
    </header>

    <div id="main-loading" class="text-center p-12 text-indigo-400">
        <svg class="animate-spin h-8 w-8 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4">Connecting to Database...</p>
    </div>

    <!-- Whitelist Access Gate -->
    <div id="whitelist-gate" class="hidden transition-opacity duration-300">
        <div class="bg-gray-700 p-8 rounded-xl shadow-2xl max-w-md w-full text-center border-t-4 border-indigo-500">
            <h2 class="text-2xl font-bold text-white mb-2">Restricted Access</h2>
            <p class="text-gray-300 mb-6">Please enter a whitelisted email address to view the dashboard.</p>
            <input type="email" id="email-input" placeholder="Enter your email..." 
                   class="w-full p-3 mb-4 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="access-btn" 
                    class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition duration-200 shadow-md">
                Grant Access
            </button>
            <p id="error-message" class="text-red-400 mt-4 h-5"></p>
        </div>
    </div>
    
    <div id="reports-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
        <!-- Data reports will be injected here -->
    </div>
    
    <div id="no-data" class="hidden text-center p-16 text-gray-500">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mx-auto mb-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v2.25m-4.5-4.5h.008v.008h-.008v-.008zm-4.5 0h.008v.008h-.008v-.008zm-9 0a9 9 0 1 1 18 0 9 9 0 0 1-18 0z" />
        </svg>
        <p class="text-xl font-semibold">No reports logged yet.</p>
        <p class="text-sm">Reports will appear here once the client site sends data.</p>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, query, where, limit, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // setLogLevel('Debug'); // Uncomment for debugging Firestore/Auth issues

        // --- Firebase Global Variables (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- WHITELIST EMAILS ---
        const WHITELIST = [
            "jacehawkins951@gmail.com",
            "jacehawkins16@gmail.com"
        ];

        // --- DOM Elements ---
        const mainLoadingEl = document.getElementById('main-loading');
        const whitelistGateEl = document.getElementById('whitelist-gate');
        const emailInputEl = document.getElementById('email-input');
        const accessBtn = document.getElementById('access-btn');
        const errorMsgEl = document.getElementById('error-message');
        const reportsContainer = document.getElementById('reports-container');
        const noDataEl = document.getElementById('no-data');
        const appIdDisplay = document.getElementById('app-id-display');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- Firebase Instances ---
        let app, auth, db, userId;

        /**
         * Shows the access gate and sets up the event listener.
         */
        function showEmailGate() {
            mainLoadingEl.classList.add('hidden');
            whitelistGateEl.classList.remove('hidden');
            emailInputEl.focus();

            // Handle access button click
            accessBtn.onclick = handleEmailCheck;
            
            // Handle Enter keypress
            emailInputEl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleEmailCheck();
                }
            });
        }

        /**
         * Checks the entered email against the WHITELIST.
         */
        function handleEmailCheck() {
            const enteredEmail = emailInputEl.value.trim().toLowerCase();
            errorMsgEl.textContent = ''; // Clear previous errors

            if (!enteredEmail) {
                errorMsgEl.textContent = "Please enter an email address.";
                return;
            }

            if (WHITELIST.includes(enteredEmail)) {
                // Access Granted!
                whitelistGateEl.classList.add('opacity-0');
                setTimeout(() => {
                    whitelistGateEl.classList.add('hidden');
                    // Proceed to load data
                    setupFirestoreListener();
                }, 300); 

            } else {
                // Access Denied
                errorMsgEl.textContent = "Access denied. Your email is not whitelisted.";
                
                // Optional: Visually indicate denial (e.g., shake input)
                emailInputEl.classList.add('ring-4', 'ring-red-500', 'animate-pulse');
                setTimeout(() => {
                    emailInputEl.classList.remove('ring-4', 'ring-red-500', 'animate-pulse');
                }, 1000);
            }
        }
        
        /**
         * Converts the raw data object into HTML for display.
         * @param {object} reportData The data object from Firestore.
         * @returns {string} The HTML string for the report card.
         */
        function createReportCard(reportData) {
            const time = reportData.localTimeFormatted || new Date(reportData.logTimestamp).toLocaleString() || 'N/A';
            
            // Utility to format a key-value pair
            const field = (label, value) => `
                <p class="text-sm mb-1">
                    <span class="font-semibold text-indigo-400">${label}:</span> 
                    <span class="text-gray-200 font-mono text-xs break-all">${value || 'N/A'}</span>
                </p>`;
            
            // Utility to format a section
            const section = (title, content) => `
                <div class="mb-4">
                    <h3 class="font-bold text-indigo-300 border-b border-indigo-700 pb-1 mb-2">${title}</h3>
                    ${content}
                </div>`;

            // Core Network
            const coreNetwork = section("Network Identity", `
                ${field('IP Address', reportData.ip)}
                ${field('Org / ISP', reportData.org)}
                ${field('API Source', reportData.apiSource)}
            `);

            // Location
            const location = section("Geo Location", `
                ${field('Country', `${reportData.countryCode || 'N/A'} (TZ: ${reportData.ipTimezone || 'N/A'})`)}
                ${field('City', `${reportData.city}, ${reportData.region}`)}
                ${field('Coordinates', reportData.coords)}
            `);
            
            // Client Device
            const clientDevice = section("Client Device", `
                ${field('Name', reportData.name)}
                ${field('OS / Browser', `${reportData.os} / ${reportData.browser}`)}
                ${field('Resolution', reportData.resolution)}
                ${field('Connection', reportData.connectionSpeed)}
            `);


            return `
                <div class="data-card p-6 rounded-xl shadow-xl">
                    <div class="flex justify-between items-start mb-4 border-b border-gray-600 pb-2">
                        <h2 class="text-xl font-bold text-white">${reportData.name} Report</h2>
                        <span class="text-xs text-gray-500 whitespace-nowrap pt-1">${time}</span>
                    </div>
                    ${coreNetwork}
                    ${location}
                    ${clientDevice}
                    
                    <button data-doc-id="${reportData.id}" class="delete-btn mt-4 w-full py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-lg transition duration-200">
                        Delete Report
                    </button>
                </div>
            `;
        }
        
        /**
         * Renders the fetched data list to the reports container.
         * @param {Array<object>} reports An array of report objects.
         */
        function renderReports(reports) {
            reportsContainer.innerHTML = '';
            
            if (reports.length === 0) {
                reportsContainer.classList.add('hidden');
                noDataEl.classList.remove('hidden');
            } else {
                noDataEl.classList.add('hidden');
                reportsContainer.classList.remove('hidden');
                
                // Sort by timestamp (most recent first)
                reports.sort((a, b) => new Date(b.logTimestamp) - new Date(a.logTimestamp));
                
                reports.forEach(report => {
                    reportsContainer.insertAdjacentHTML('beforeend', createReportCard(report));
                });
                
                attachDeleteListeners();
            }
        }

        /**
         * Deletes a report document from Firestore.
         * @param {string} docId The ID of the document to delete.
         */
        async function deleteReport(docId) {
            if (!db || !userId) {
                console.error("Database or User ID not initialized.");
                return;
            }
            
            // Define the collection path based on security rules (Public data for sharing)
            const publicDataPath = `artifacts/${appId}/public/data/network_reports`;
            
            try {
                // In a real scenario, this would check if the current user has delete permission
                await deleteDoc(doc(db, publicDataPath, docId));
                console.log(`Document successfully deleted: ${docId}`);
            } catch (error) {
                console.error("Error removing document: ", error);
            }
        }

        /**
         * Attaches event listeners to all delete buttons.
         */
        function attachDeleteListeners() {
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = () => {
                    const docId = button.getAttribute('data-doc-id');
                    if (docId) {
                        deleteReport(docId);
                    }
                };
            });
        }
        
        /**
         * Sets up the real-time Firestore listener (onSnapshot).
         */
        function setupFirestoreListener() {
            // Path is the public path, as the client app is sending data here
            const publicDataPath = `artifacts/${appId}/public/data/network_reports`;
            const reportsCol = collection(db, publicDataPath);
            
            // Query to fetch reports (e.g., limit to 50 for performance)
            const reportsQuery = query(reportsCol, limit(50));
            
            // Set up real-time listener
            onSnapshot(reportsQuery, (snapshot) => {
                const reports = [];
                snapshot.forEach(doc => {
                    reports.push({ id: doc.id, ...doc.data() });
                });
                renderReports(reports);
            }, (error) => {
                console.error("Firestore real-time listener failed:", error);
                mainLoadingEl.innerHTML = `<p class="text-red-500">Failed to load reports: ${error.message}</p>`;
                reportsContainer.classList.add('hidden');
            });
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.error("Firebase configuration is missing or incomplete.");
                mainLoadingEl.innerHTML = `<p class="text-red-500">Error: Firebase configuration missing.</p>`;
                return;
            }
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Display static info
            appIdDisplay.textContent = `App ID: ${appId}`;
            
            try {
                // 1. Ensure persistence is set before sign-in
                await setPersistence(auth, browserLocalPersistence);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 2. Wait for auth state change to confirm sign-in
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            userIdDisplay.textContent = `User ID: ${userId}`;
                            unsubscribe();
                            resolve();
                        }
                    });
                });
                
                // 3. Once authenticated for Firestore, present the email gate
                showEmailGate();

            } catch (error) {
                console.error("Firebase Auth or Init failed:", error);
                userIdDisplay.textContent = `User ID: ERROR`;
                mainLoadingEl.innerHTML = `<p class="text-red-500">Authentication failed: ${error.message}</p>`;
            }
        }

        // Start the application
        initFirebase();
    </script>
</body>
</html>
